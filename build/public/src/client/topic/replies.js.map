{"version":3,"sources":["public/src/client/topic/replies.js"],"names":["define","navigator","components","posts","Replies","init","button","post","closest","pid","data","open","find","loading","close","is","addClass","removeClass","socket","emit","err","app","alertError","message","modifyPostsByPrivileges","tplData","privileges","ajaxify","downvote:disabled","reputation:disabled","loggedIn","user","uid","hideReplies","config","hasOwnProperty","showNestedReplies","parseAndTranslate","html","$","component","hide","insertAfter","slideDown","onNewPostsAddedToDom","window","trigger","slideUp","this","remove","onNewPost","incrementCount","replies","toPid","first","length","append","onPostPurged","inc","replyCount","countEl","avatars","count","Math","max","parseInt","attr","timestamp","timestampISO","toggleClass","translateText","users","prepend","timeago"],"mappings":"AAAA,aAGAA,OAAO,uBAAwB,YAAa,aAAc,qBAAsB,SAAUC,EAAWC,EAAYC,GAChH,IAAIC,KAEJA,EAAQC,KAAO,SAAUC,GACxB,IAAIC,EAAOD,EAAOE,QAAQ,cAC1B,IAAIC,EAAMF,EAAKG,KAAK,OACpB,IAAIC,EAAOL,EAAOM,KAAK,mCACvB,IAAIC,EAAUP,EAAOM,KAAK,sCAC1B,IAAIE,EAAQR,EAAOM,KAAK,oCAExB,GAAID,EAAKI,GAAG,kBAAoBF,EAAQE,GAAG,WAAY,CACtDJ,EAAKK,SAAS,UACdH,EAAQI,YAAY,UAEpBC,OAAOC,KAAK,mBAAoBV,EAAK,SAAUW,EAAKV,GACnDG,EAAQG,SAAS,UACjB,GAAII,EAAK,CACRT,EAAKM,YAAY,UACjB,OAAOI,IAAIC,WAAWF,EAAIG,SAG3BT,EAAMG,YAAY,UAElBd,EAAMqB,wBAAwBd,GAC9B,IAAIe,GACHtB,MAAOO,EACPgB,WAAYC,QAAQjB,KAAKgB,WACzBE,oBAAqBD,QAAQjB,KAAK,qBAClCmB,sBAAuBF,QAAQjB,KAAK,uBACpCoB,WAAYT,IAAIU,KAAKC,IACrBC,YAAaC,OAAOC,eAAe,sBAAwBD,OAAOE,kBAAoB,MAEvFf,IAAIgB,kBAAkB,QAAS,QAASZ,EAAS,SAAUa,GAC1DC,EAAE,SAAWC,UAAW,iBAAkBF,KAAKA,GAAMG,OAAOC,YAAYpC,GACtEqC,UAAU,QACZxC,EAAMyC,qBAAqBN,GAC3BC,EAAEM,QAAQC,QAAQ,uBAAyB3C,MAAOO,aAG9C,GAAII,EAAMC,GAAG,iBAAkB,CACrCD,EAAME,SAAS,UACfL,EAAKM,YAAY,UACjBJ,EAAQG,SAAS,UACjBT,EAAKK,KAAK,8BAA8BmC,QAAQ,OAAQ,WACvDR,EAAES,MAAMC,aAKX7C,EAAQ8C,UAAY,SAAUxC,GAC7B,IAAIH,EAAOG,EAAKP,MAAM,GACtB,IAAKI,EAAM,CACV,OAED4C,EAAe5C,EAAM,GACrBG,EAAKuB,YAAcC,OAAOC,eAAe,sBAAwBD,OAAOE,kBAAoB,KAC5Ff,IAAIgB,kBAAkB,QAAS,QAAS3B,EAAM,SAAU4B,GACvD,IAAIc,EAAUb,EAAE,gCAAkChC,EAAK8C,MAAQ,iCAAiCC,QAChG,GAAIF,EAAQG,OAAQ,CACnBH,EAAQI,OAAOlB,GACfnC,EAAMyC,qBAAqBN,OAK9BlC,EAAQqD,aAAe,SAAUlD,GAChC4C,EAAe5C,GAAO,IAGvB,SAAS4C,EAAe5C,EAAMmD,GAC7B,IAAIC,EAAapB,EAAE,gCAAkChC,EAAK8C,MAAQ,MAAMzC,KAAK,kCAAkC0C,QAC/G,IAAIM,EAAUD,EAAW/C,KAAK,uCAC9B,IAAIiD,EAAUF,EAAW/C,KAAK,0CAC9B,IAAIkD,EAAQC,KAAKC,IAAI,EAAGC,SAASL,EAAQM,KAAK,gBAAiB,IAAMR,GACrE,IAAIS,EAAYR,EAAW/C,KAAK,YAAYsD,KAAK,QAAS3D,EAAK6D,cAE/DR,EAAQM,KAAK,eAAgBJ,GAC7BH,EAAWU,YAAY,SAAUP,GAAS,GAC1C,GAAIA,EAAQ,EAAG,CACdF,EAAQU,cAAc,iCAAmCR,EAAQ,UAC3D,CACNF,EAAQU,cAAc,oCAGvB,IAAKT,EAAQjD,KAAK,cAAgBL,EAAKyB,IAAM,MAAMuB,QAAUO,EAAQ,EAAG,CACvEzC,IAAIgB,kBAAkB,QAAS,SAAWlC,QAAUiD,SAAWmB,OAAQhE,EAAKwB,UAAc,SAAUO,GACnGuB,EAAQW,QAAQlC,EAAK1B,KAAK,wEAI5BiD,EAAQ7C,SAAS,WAEjBmD,EAAUzD,KAAK,UAAW,MAAM+D,UAGjC,OAAOrE","file":"public/src/client/topic/replies.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/replies', ['navigator', 'components', 'forum/topic/posts'], function (navigator, components, posts) {\r\n\tvar Replies = {};\r\n\r\n\tReplies.init = function (button) {\r\n\t\tvar post = button.closest('[data-pid]');\r\n\t\tvar pid = post.data('pid');\r\n\t\tvar open = button.find('[component=\"post/replies/open\"]');\r\n\t\tvar loading = button.find('[component=\"post/replies/loading\"]');\r\n\t\tvar close = button.find('[component=\"post/replies/close\"]');\r\n\r\n\t\tif (open.is(':not(.hidden)') && loading.is('.hidden')) {\r\n\t\t\topen.addClass('hidden');\r\n\t\t\tloading.removeClass('hidden');\r\n\r\n\t\t\tsocket.emit('posts.getReplies', pid, function (err, data) {\r\n\t\t\t\tloading.addClass('hidden');\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\topen.removeClass('hidden');\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tclose.removeClass('hidden');\r\n\r\n\t\t\t\tposts.modifyPostsByPrivileges(data);\r\n\t\t\t\tvar tplData = {\r\n\t\t\t\t\tposts: data,\r\n\t\t\t\t\tprivileges: ajaxify.data.privileges,\r\n\t\t\t\t\t'downvote:disabled': ajaxify.data['downvote:disabled'],\r\n\t\t\t\t\t'reputation:disabled': ajaxify.data['reputation:disabled'],\r\n\t\t\t\t\tloggedIn: !!app.user.uid,\r\n\t\t\t\t\thideReplies: config.hasOwnProperty('showNestedReplies') ? !config.showNestedReplies : true,\r\n\t\t\t\t};\r\n\t\t\t\tapp.parseAndTranslate('topic', 'posts', tplData, function (html) {\r\n\t\t\t\t\t$('<div>', { component: 'post/replies' }).html(html).hide().insertAfter(button)\r\n\t\t\t\t\t\t.slideDown('fast');\r\n\t\t\t\t\tposts.onNewPostsAddedToDom(html);\r\n\t\t\t\t\t$(window).trigger('action:posts.loaded', { posts: data });\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t} else if (close.is(':not(.hidden)')) {\r\n\t\t\tclose.addClass('hidden');\r\n\t\t\topen.removeClass('hidden');\r\n\t\t\tloading.addClass('hidden');\r\n\t\t\tpost.find('[component=\"post/replies\"]').slideUp('fast', function () {\r\n\t\t\t\t$(this).remove();\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tReplies.onNewPost = function (data) {\r\n\t\tvar post = data.posts[0];\r\n\t\tif (!post) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tincrementCount(post, 1);\r\n\t\tdata.hideReplies = config.hasOwnProperty('showNestedReplies') ? !config.showNestedReplies : true;\r\n\t\tapp.parseAndTranslate('topic', 'posts', data, function (html) {\r\n\t\t\tvar replies = $('[component=\"post\"][data-pid=\"' + post.toPid + '\"] [component=\"post/replies\"]').first();\r\n\t\t\tif (replies.length) {\r\n\t\t\t\treplies.append(html);\r\n\t\t\t\tposts.onNewPostsAddedToDom(html);\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tReplies.onPostPurged = function (post) {\r\n\t\tincrementCount(post, -1);\r\n\t};\r\n\r\n\tfunction incrementCount(post, inc) {\r\n\t\tvar replyCount = $('[component=\"post\"][data-pid=\"' + post.toPid + '\"]').find('[component=\"post/reply-count\"]').first();\r\n\t\tvar countEl = replyCount.find('[component=\"post/reply-count/text\"]');\r\n\t\tvar avatars = replyCount.find('[component=\"post/reply-count/avatars\"]');\r\n\t\tvar count = Math.max(0, parseInt(countEl.attr('data-replies'), 10) + inc);\r\n\t\tvar timestamp = replyCount.find('.timeago').attr('title', post.timestampISO);\r\n\r\n\t\tcountEl.attr('data-replies', count);\r\n\t\treplyCount.toggleClass('hidden', count <= 0);\r\n\t\tif (count > 1) {\r\n\t\t\tcountEl.translateText('[[topic:replies_to_this_post, ' + count + ']]');\r\n\t\t} else {\r\n\t\t\tcountEl.translateText('[[topic:one_reply_to_this_post]]');\r\n\t\t}\r\n\r\n\t\tif (!avatars.find('[data-uid=\"' + post.uid + '\"]').length && count < 7) {\r\n\t\t\tapp.parseAndTranslate('topic', 'posts', { posts: [{ replies: { users: [post.user] } }] }, function (html) {\r\n\t\t\t\tavatars.prepend(html.find('[component=\"post/reply-count/avatars\"] [component=\"user/picture\"]'));\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tavatars.addClass('hasMore');\r\n\r\n\t\ttimestamp.data('timeago', null).timeago();\r\n\t}\r\n\r\n\treturn Replies;\r\n});\r\n"]}