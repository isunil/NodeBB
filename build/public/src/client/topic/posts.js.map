{"version":3,"sources":["public/src/client/topic/posts.js"],"names":["define","pagination","infinitescroll","postTools","images","navigator","components","translator","Posts","onNewPost","data","posts","length","parseInt","tid","ajaxify","loggedIn","app","user","uid","privileges","timestamp","Date","now","timestampISO","utils","toISOString","modifyPostsByPrivileges","updatePostCounts","updatePostIndices","postcount","updatePostCount","config","usePagination","onNewPostPagination","onNewPostInfiniteScroll","require","replies","forEach","post","selfPost","display_edit_tools","isAdminOrMod","display_delete_tools","display_moderator_tools","display_move_tools","display_post_menu","locked","postSharing","deleted","i","cmp","get","html","attr","addCommasToNumbers","topicPostSort","index","not","each","newIndex","$","this","scrollToPost","scrollToPostIfSelf","pageCount","Math","max","ceil","topic","postsPerPage","direction","isPostVisible","currentPage","createNewPosts","scrollToMyPost","setTimeout","loadPage","updatePagination","relative_path","page","paginationData","parseAndTranslate","after","remove","isPreviousPostAdded","go","pid","addClass","scrollBottom","repliesSelector","callback","removeAlreadyAddedPosts","newPosts","allSamePids","el","removeClass","p","hasClass","filter","before","last","first","slug","window","trigger","insertAfter","height","document","scrollTop","insertBefore","append","removeExtra","onNewPostsAddedToDom","loadMorePosts","scrollActive","_infiniteScrollTimeout","find","afterEl","isNumber","indicatorEl","is","fadeIn","loadMore","count","done","fadeOut","update","onTopicPageLoad","handlePrivateUploads","wrapImagesInLinks","showBottomPostBar","addBlockquoteEllipses","hidePostToolsForDeletedPosts","addNecroPostMessage","necroThreshold","prev","diff","abs","suffixAgo","timeago","settings","strings","prefixAgo","suffixFromNow","prefixFromNow","translationText","inWords","text","prependTo","privateUploads","loginEl","createElement","className","href","translate","translated","appendChild","createTextNode","idx","postEl","imgEl","startsWith","upload_url","replaceWith","cloneNode","createUserTooltips","makeNumbersHumanReadable","mainPost","placeHolder","clone","toggle","blockquotes","$this"],"mappings":"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","file":"public/src/client/topic/posts.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('forum/topic/posts', [\r\n\t'forum/pagination',\r\n\t'forum/infinitescroll',\r\n\t'forum/topic/postTools',\r\n\t'forum/topic/images',\r\n\t'navigator',\r\n\t'components',\r\n\t'translator',\r\n], function (pagination, infinitescroll, postTools, images, navigator, components, translator) {\r\n\tvar Posts = { };\r\n\r\n\tPosts.onNewPost = function (data) {\r\n\t\tif (!data || !data.posts || !data.posts.length || parseInt(data.posts[0].tid, 10) !== parseInt(ajaxify.data.tid, 10)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tdata.loggedIn = !!app.user.uid;\r\n\t\tdata.privileges = ajaxify.data.privileges;\r\n\r\n\t\t// prevent timeago in future by setting timestamp to 1 sec behind now\r\n\t\tdata.posts[0].timestamp = Date.now() - 1000;\r\n\t\tdata.posts[0].timestampISO = utils.toISOString(data.posts[0].timestamp);\r\n\r\n\t\tPosts.modifyPostsByPrivileges(data.posts);\r\n\r\n\t\tupdatePostCounts(data.posts);\r\n\r\n\t\tupdatePostIndices(data.posts);\r\n\r\n\t\tajaxify.data.postcount += 1;\r\n\t\tpostTools.updatePostCount(ajaxify.data.postcount);\r\n\r\n\t\tif (config.usePagination) {\r\n\t\t\tonNewPostPagination(data);\r\n\t\t} else {\r\n\t\t\tonNewPostInfiniteScroll(data);\r\n\t\t}\r\n\r\n\t\trequire(['forum/topic/replies'], function (replies) {\r\n\t\t\treplies.onNewPost(data);\r\n\t\t});\r\n\t};\r\n\r\n\tPosts.modifyPostsByPrivileges = function (posts) {\r\n\t\tposts.forEach(function (post) {\r\n\t\t\tpost.selfPost = !!app.user.uid && parseInt(post.uid, 10) === parseInt(app.user.uid, 10);\r\n\t\t\tpost.display_edit_tools = (ajaxify.data.privileges['posts:edit'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_delete_tools = (ajaxify.data.privileges['posts:delete'] && post.selfPost) || ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_moderator_tools = post.display_edit_tools || post.display_delete_tools;\r\n\t\t\tpost.display_move_tools = ajaxify.data.privileges.isAdminOrMod;\r\n\t\t\tpost.display_post_menu = ajaxify.data.privileges.isAdminOrMod || (post.selfPost && !ajaxify.data.locked) || ((app.user.uid || ajaxify.data.postSharing.length) && !post.deleted);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction updatePostCounts(posts) {\r\n\t\tfor (var i = 0; i < posts.length; i += 1) {\r\n\t\t\tvar cmp = components.get('user/postcount', posts[i].uid);\r\n\t\t\tcmp.html(parseInt(cmp.attr('data-postcount'), 10) + 1);\r\n\t\t\tutils.addCommasToNumbers(cmp);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction updatePostIndices(posts) {\r\n\t\tif (config.topicPostSort === 'newest_to_oldest') {\r\n\t\t\tposts[0].index = 1;\r\n\t\t\tcomponents.get('post').not('[data-index=0]').each(function () {\r\n\t\t\t\tvar newIndex = parseInt($(this).attr('data-index'), 10) + 1;\r\n\t\t\t\t$(this).attr('data-index', newIndex);\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tfunction onNewPostPagination(data) {\r\n\t\tfunction scrollToPost() {\r\n\t\t\tscrollToPostIfSelf(data.posts[0]);\r\n\t\t}\r\n\r\n\t\tvar posts = data.posts;\r\n\r\n\t\tajaxify.data.pagination.pageCount = Math.max(1, Math.ceil(posts[0].topic.postcount / config.postsPerPage));\r\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\r\n\r\n\t\tvar isPostVisible = (ajaxify.data.pagination.currentPage === ajaxify.data.pagination.pageCount && direction === 1) ||\r\n\t\t\t\t\t\t\t(ajaxify.data.pagination.currentPage === 1 && direction === -1);\r\n\r\n\t\tif (isPostVisible) {\r\n\t\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, scrollToPost);\r\n\t\t} else if (ajaxify.data.scrollToMyPost && parseInt(posts[0].uid, 10) === parseInt(app.user.uid, 10)) {\r\n\t\t\t// https://github.com/NodeBB/NodeBB/issues/5004#issuecomment-247157441\r\n\t\t\tsetTimeout(function () {\r\n\t\t\t\tpagination.loadPage(ajaxify.data.pagination.pageCount, scrollToPost);\r\n\t\t\t}, 250);\r\n\t\t} else {\r\n\t\t\tupdatePagination();\r\n\t\t}\r\n\t}\r\n\r\n\tfunction updatePagination() {\r\n\t\t$.get(config.relative_path + '/api/topic/pagination/' + ajaxify.data.tid, { page: ajaxify.data.pagination.currentPage }, function (paginationData) {\r\n\t\t\tapp.parseAndTranslate('partials/paginator', { pagination: paginationData }, function (html) {\r\n\t\t\t\t$('[component=\"pagination\"]').after(html).remove();\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tfunction onNewPostInfiniteScroll(data) {\r\n\t\tvar direction = config.topicPostSort === 'oldest_to_newest' || config.topicPostSort === 'most_votes' ? 1 : -1;\r\n\r\n\t\tvar isPreviousPostAdded = $('[component=\"post\"][data-index=\"' + (data.posts[0].index - 1) + '\"]').length;\r\n\t\tif (!isPreviousPostAdded && (!data.posts[0].selfPost || !ajaxify.data.scrollToMyPost)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (!isPreviousPostAdded && data.posts[0].selfPost) {\r\n\t\t\treturn ajaxify.go('post/' + data.posts[0].pid);\r\n\t\t}\r\n\r\n\t\tcreateNewPosts(data, components.get('post').not('[data-index=0]'), direction, function (html) {\r\n\t\t\tif (html) {\r\n\t\t\t\thtml.addClass('new');\r\n\t\t\t}\r\n\t\t\tscrollToPostIfSelf(data.posts[0]);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction scrollToPostIfSelf(post) {\r\n\t\tif (post.selfPost && ajaxify.data.scrollToMyPost) {\r\n\t\t\tnavigator.scrollBottom(post.index);\r\n\t\t}\r\n\t}\r\n\r\n\tfunction createNewPosts(data, repliesSelector, direction, callback) {\r\n\t\tcallback = callback || function () {};\r\n\t\tif (!data || (data.posts && !data.posts.length)) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tfunction removeAlreadyAddedPosts() {\r\n\t\t\tvar newPosts = $('[component=\"post\"].new');\r\n\r\n\t\t\tif (newPosts.length === data.posts.length) {\r\n\t\t\t\tvar allSamePids = true;\r\n\t\t\t\tnewPosts.each(function (index, el) {\r\n\t\t\t\t\tif (parseInt($(el).attr('data-pid'), 10) !== parseInt(data.posts[index].pid, 10)) {\r\n\t\t\t\t\t\tallSamePids = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (allSamePids) {\r\n\t\t\t\t\tnewPosts.each(function () {\r\n\t\t\t\t\t\t$(this).removeClass('new');\r\n\t\t\t\t\t});\r\n\t\t\t\t\tdata.posts.length = 0;\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (newPosts.length && data.posts.length > 1) {\r\n\t\t\t\tdata.posts.forEach(function (post) {\r\n\t\t\t\t\tvar p = components.get('post', 'pid', post.pid);\r\n\t\t\t\t\tif (p.hasClass('new')) {\r\n\t\t\t\t\t\tp.remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tdata.posts = data.posts.filter(function (post) {\r\n\t\t\t\treturn $('[component=\"post\"][data-pid=\"' + post.pid + '\"]').length === 0;\r\n\t\t\t});\r\n\t\t}\r\n\r\n\t\tremoveAlreadyAddedPosts();\r\n\r\n\t\tif (!data.posts.length) {\r\n\t\t\treturn callback();\r\n\t\t}\r\n\r\n\t\tvar after;\r\n\t\tvar before;\r\n\r\n\t\tif (direction > 0 && repliesSelector.length) {\r\n\t\t\tafter = repliesSelector.last();\r\n\t\t} else if (direction < 0 && repliesSelector.length) {\r\n\t\t\tbefore = repliesSelector.first();\r\n\t\t}\r\n\r\n\t\tdata.slug = ajaxify.data.slug;\r\n\r\n\t\t$(window).trigger('action:posts.loading', { posts: data.posts, after: after, before: before });\r\n\r\n\t\tapp.parseAndTranslate('topic', 'posts', data, function (html) {\r\n\t\t\thtml = html.filter(function () {\r\n\t\t\t\tvar pid = $(this).attr('data-pid');\r\n\t\t\t\treturn pid && $('[component=\"post\"][data-pid=\"' + pid + '\"]').length === 0;\r\n\t\t\t});\r\n\r\n\t\t\tif (after) {\r\n\t\t\t\thtml.insertAfter(after);\r\n\t\t\t} else if (before) {\r\n\t\t\t\t// Save document height and position for future reference (about 5 lines down)\r\n\t\t\t\tvar height = $(document).height();\r\n\t\t\t\tvar scrollTop = $(window).scrollTop();\r\n\r\n\t\t\t\thtml.insertBefore(before);\r\n\r\n\t\t\t\t// Now restore the relative position the user was on prior to new post insertion\r\n\t\t\t\t$(window).scrollTop(scrollTop + ($(document).height() - height));\r\n\t\t\t} else {\r\n\t\t\t\tcomponents.get('topic').append(html);\r\n\t\t\t}\r\n\r\n\t\t\tinfinitescroll.removeExtra($('[component=\"post\"]'), direction, Math.max(20, config.postsPerPage * 2));\r\n\r\n\t\t\t$(window).trigger('action:posts.loaded', { posts: data.posts });\r\n\r\n\t\t\tPosts.onNewPostsAddedToDom(html);\r\n\r\n\t\t\tcallback(html);\r\n\t\t});\r\n\t}\r\n\r\n\tPosts.loadMorePosts = function (direction) {\r\n\t\tif (!components.get('topic').length || navigator.scrollActive || Posts._infiniteScrollTimeout) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tPosts._infiniteScrollTimeout = setTimeout(function () {\r\n\t\t\tdelete Posts._infiniteScrollTimeout;\r\n\t\t}, 1000);\r\n\t\tvar replies = components.get('topic').find(components.get('post').not('[data-index=0]').not('.new'));\r\n\t\tvar afterEl = direction > 0 ? replies.last() : replies.first();\r\n\t\tvar after = parseInt(afterEl.attr('data-index'), 10) || 0;\r\n\r\n\t\tvar tid = ajaxify.data.tid;\r\n\t\tif (!utils.isNumber(tid) || !utils.isNumber(after) || (direction < 0 && components.get('post', 'index', 0).length)) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tvar indicatorEl = $('.loading-indicator');\r\n\t\tif (!indicatorEl.is(':animated')) {\r\n\t\t\tindicatorEl.fadeIn();\r\n\t\t}\r\n\r\n\t\tinfinitescroll.loadMore('topics.loadMore', {\r\n\t\t\ttid: tid,\r\n\t\t\tafter: after,\r\n\t\t\tcount: config.postsPerPage,\r\n\t\t\tdirection: direction,\r\n\t\t\ttopicPostSort: config.topicPostSort,\r\n\t\t}, function (data, done) {\r\n\t\t\tindicatorEl.fadeOut();\r\n\r\n\t\t\tif (data && data.posts && data.posts.length) {\r\n\t\t\t\tcreateNewPosts(data, replies, direction, done);\r\n\t\t\t} else {\r\n\t\t\t\tnavigator.update();\r\n\t\t\t\tdone();\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tPosts.onTopicPageLoad = function (posts) {\r\n\t\thandlePrivateUploads(posts);\r\n\t\timages.wrapImagesInLinks(posts);\r\n\t\tPosts.showBottomPostBar();\r\n\t\tposts.find('[component=\"post/content\"] img:not(.not-responsive)').addClass('img-responsive');\r\n\t\tPosts.addBlockquoteEllipses(posts);\r\n\t\thidePostToolsForDeletedPosts(posts);\r\n\t\taddNecroPostMessage();\r\n\t};\r\n\r\n\tfunction addNecroPostMessage() {\r\n\t\tvar necroThreshold = ajaxify.data.necroThreshold * 24 * 60 * 60 * 1000;\r\n\t\tif (!necroThreshold || (config.topicPostSort !== 'newest_to_oldest' && config.topicPostSort !== 'oldest_to_newest')) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t$('[component=\"post\"]').each(function () {\r\n\t\t\tvar post = $(this);\r\n\t\t\tvar prev = post.prev('[component=\"post\"]');\r\n\t\t\tif (post.is(':has(.necro-post)') || !prev.length) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tif (config.topicPostSort === 'newest_to_oldest' && parseInt(prev.attr('data-index'), 10) === 0) {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tvar diff = post.attr('data-timestamp') - prev.attr('data-timestamp');\r\n\t\t\tif (Math.abs(diff) >= necroThreshold) {\r\n\t\t\t\tvar suffixAgo = $.timeago.settings.strings.suffixAgo;\r\n\t\t\t\tvar prefixAgo = $.timeago.settings.strings.prefixAgo;\r\n\t\t\t\tvar suffixFromNow = $.timeago.settings.strings.suffixFromNow;\r\n\t\t\t\tvar prefixFromNow = $.timeago.settings.strings.prefixFromNow;\r\n\r\n\t\t\t\t$.timeago.settings.strings.suffixAgo = '';\r\n\t\t\t\t$.timeago.settings.strings.prefixAgo = '';\r\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = '';\r\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = '';\r\n\r\n\t\t\t\tvar translationText = (diff > 0 ? '[[topic:timeago_later,' : '[[topic:timeago_earlier,') + $.timeago.inWords(diff) + ']]';\r\n\r\n\t\t\t\t$.timeago.settings.strings.suffixAgo = suffixAgo;\r\n\t\t\t\t$.timeago.settings.strings.prefixAgo = prefixAgo;\r\n\t\t\t\t$.timeago.settings.strings.suffixFromNow = suffixFromNow;\r\n\t\t\t\t$.timeago.settings.strings.prefixFromNow = prefixFromNow;\r\n\t\t\t\tapp.parseAndTranslate('partials/topic/necro-post', { text: translationText }, function (html) {\r\n\t\t\t\t\thtml.prependTo(post);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tfunction handlePrivateUploads(posts) {\r\n\t\tif (app.user.uid || !ajaxify.data.privateUploads) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Replace all requests for uploaded images/files with a login link\r\n\t\tvar loginEl = document.createElement('a');\r\n\t\tloginEl.className = 'login-required';\r\n\t\tloginEl.href = config.relative_path + '/login';\r\n\r\n\t\ttranslator.translate('[[topic:login-to-view]]', function (translated) {\r\n\t\t\tloginEl.appendChild(document.createTextNode(translated));\r\n\t\t\tposts.each(function (idx, postEl) {\r\n\t\t\t\t$(postEl).find('[component=\"post/content\"] img').each(function (idx, imgEl) {\r\n\t\t\t\t\timgEl = $(imgEl);\r\n\t\t\t\t\tif (imgEl.attr('src').startsWith(config.relative_path + config.upload_url)) {\r\n\t\t\t\t\t\timgEl.replaceWith(loginEl.cloneNode(true));\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t});\r\n\t}\r\n\r\n\tPosts.onNewPostsAddedToDom = function (posts) {\r\n\t\tPosts.onTopicPageLoad(posts);\r\n\r\n\t\tapp.createUserTooltips(posts);\r\n\r\n\t\tutils.addCommasToNumbers(posts.find('.formatted-number'));\r\n\t\tutils.makeNumbersHumanReadable(posts.find('.human-readable-number'));\r\n\t\tposts.find('.timeago').timeago();\r\n\t};\r\n\r\n\tPosts.showBottomPostBar = function () {\r\n\t\tvar mainPost = components.get('post', 'index', 0);\r\n\t\tvar placeHolder = $('.post-bar-placeholder');\r\n\t\tvar posts = $('[component=\"post\"]');\r\n\t\tif (!!mainPost.length && posts.length > 1 && $('.post-bar').length < 2 && placeHolder.length) {\r\n\t\t\t$('.post-bar').clone().insertAfter(placeHolder);\r\n\t\t\tplaceHolder.remove();\r\n\t\t} else if (mainPost.length && posts.length < 2) {\r\n\t\t\tmainPost.find('.post-bar').remove();\r\n\t\t}\r\n\t};\r\n\r\n\tfunction hidePostToolsForDeletedPosts(posts) {\r\n\t\tposts.each(function () {\r\n\t\t\tif ($(this).hasClass('deleted')) {\r\n\t\t\t\tpostTools.toggle($(this).attr('data-pid'), true);\r\n\t\t\t}\r\n\t\t});\r\n\t}\r\n\r\n\tPosts.addBlockquoteEllipses = function (posts) {\r\n\t\tvar blockquotes = posts.find('[component=\"post/content\"] > blockquote > blockquote');\r\n\t\tblockquotes.each(function () {\r\n\t\t\tvar $this = $(this);\r\n\t\t\tif ($this.find(':hidden:not(br)').length && !$this.find('.toggle').length) {\r\n\t\t\t\t$this.append('<i class=\"fa fa-angle-down pointer toggle\"></i>');\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\treturn Posts;\r\n});\r\n"]}