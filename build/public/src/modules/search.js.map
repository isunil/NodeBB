{"version":3,"sources":["public/src/modules/search.js"],"names":["define","nav","translator","storage","Search","current","query","data","callback","topicSearch","term","match","ajaxify","go","createQueryString","cleanedTerm","replace","tid","length","queryTopic","api","apiURL","config","relative_path","searchOnly","undefined","searchURL","$","get","result","url","searchIn","in","postedBy","by","encodeURIComponent","e","app","alertError","matchWords","categories","searchChildren","hasTags","parseInt","replies","repliesFilter","timeRange","timeFilter","sortBy","sortDirection","showAs","window","trigger","decodeURIComponent","param","getSearchPreferences","JSON","parse","getItem","socket","emit","err","pids","message","Array","isArray","results","sort","a","b","checkPagePresence","topicDOM","update","active","prev","index","next","topicSearchEl","start","find","html","removeAttr","pid","topicPostSort","postIndex","scrollToIndex","translate","text","removeClass","attr","require","mousetrap","bind","end","addClass","unbind"],"mappings":"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","file":"public/src/modules/search.js","sourcesContent":["'use strict';\r\n\r\n\r\ndefine('search', ['navigator', 'translator', 'storage'], function (nav, translator, storage) {\r\n\tvar Search = {\r\n\t\tcurrent: {},\r\n\t};\r\n\r\n\tSearch.query = function (data, callback) {\r\n\t\t// Detect if a tid was specified\r\n\t\tvar topicSearch = data.term.match(/^in:topic-([\\d]+) /);\r\n\t\tcallback = callback || function () {};\r\n\t\tif (!topicSearch) {\r\n\t\t\tajaxify.go('search?' + createQueryString(data));\r\n\t\t\tcallback();\r\n\t\t} else {\r\n\t\t\tvar cleanedTerm = data.term.replace(topicSearch[0], '');\r\n\t\t\tvar tid = topicSearch[1];\r\n\r\n\t\t\tif (cleanedTerm.length > 0) {\r\n\t\t\t\tSearch.queryTopic(tid, cleanedTerm, callback);\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.api = function (data, callback) {\r\n\t\tvar apiURL = config.relative_path + '/api/search?' + createQueryString(data);\r\n\t\tdata.searchOnly = undefined;\r\n\t\tvar searchURL = config.relative_path + '/search?' + createQueryString(data);\r\n\t\t$.get(apiURL, function (result) {\r\n\t\t\tresult.url = searchURL;\r\n\t\t\tcallback(result);\r\n\t\t});\r\n\t};\r\n\r\n\tfunction createQueryString(data) {\r\n\t\tvar searchIn = data.in || 'titlesposts';\r\n\t\tvar postedBy = data.by || '';\r\n\t\tvar term = data.term.replace(/^[ ?#]*/, '');\r\n\t\ttry {\r\n\t\t\tterm = encodeURIComponent(term);\r\n\t\t} catch (e) {\r\n\t\t\treturn app.alertError('[[error:invalid-search-term]]');\r\n\t\t}\r\n\r\n\t\tvar query = {\r\n\t\t\tterm: term,\r\n\t\t\tin: searchIn,\r\n\t\t};\r\n\r\n\t\tif (data.matchWords) {\r\n\t\t\tquery.matchWords = data.matchWords;\r\n\t\t}\r\n\r\n\t\tif (postedBy && postedBy.length && (searchIn === 'posts' || searchIn === 'titles' || searchIn === 'titlesposts')) {\r\n\t\t\tquery.by = postedBy;\r\n\t\t}\r\n\r\n\t\tif (data.categories && data.categories.length) {\r\n\t\t\tquery.categories = data.categories;\r\n\t\t\tif (data.searchChildren) {\r\n\t\t\t\tquery.searchChildren = data.searchChildren;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (data.hasTags && data.hasTags.length) {\r\n\t\t\tquery.hasTags = data.hasTags;\r\n\t\t}\r\n\r\n\t\tif (parseInt(data.replies, 10) > 0) {\r\n\t\t\tquery.replies = data.replies;\r\n\t\t\tquery.repliesFilter = data.repliesFilter || 'atleast';\r\n\t\t}\r\n\r\n\t\tif (data.timeRange) {\r\n\t\t\tquery.timeRange = data.timeRange;\r\n\t\t\tquery.timeFilter = data.timeFilter || 'newer';\r\n\t\t}\r\n\r\n\t\tif (data.sortBy) {\r\n\t\t\tquery.sortBy = data.sortBy;\r\n\t\t\tquery.sortDirection = data.sortDirection;\r\n\t\t}\r\n\r\n\t\tif (data.showAs) {\r\n\t\t\tquery.showAs = data.showAs;\r\n\t\t}\r\n\r\n\t\tif (data.searchOnly) {\r\n\t\t\tquery.searchOnly = data.searchOnly;\r\n\t\t}\r\n\r\n\t\t$(window).trigger('action:search.createQueryString', {\r\n\t\t\tquery: query,\r\n\t\t\tdata: data,\r\n\t\t});\r\n\r\n\t\treturn decodeURIComponent($.param(query));\r\n\t}\r\n\r\n\tSearch.getSearchPreferences = function () {\r\n\t\ttry {\r\n\t\t\treturn JSON.parse(storage.getItem('search-preferences') || '{}');\r\n\t\t} catch (e) {\r\n\t\t\treturn {};\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.queryTopic = function (tid, term) {\r\n\t\tsocket.emit('topics.search', {\r\n\t\t\ttid: tid,\r\n\t\t\tterm: term,\r\n\t\t}, function (err, pids) {\r\n\t\t\tif (err) {\r\n\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t}\r\n\r\n\t\t\tif (Array.isArray(pids)) {\r\n\t\t\t\t// Sort pids numerically & store\r\n\t\t\t\tSearch.current = {\r\n\t\t\t\t\tresults: pids.sort(function (a, b) {\r\n\t\t\t\t\t\treturn a - b;\r\n\t\t\t\t\t}),\r\n\t\t\t\t\ttid: tid,\r\n\t\t\t\t\tterm: term,\r\n\t\t\t\t};\r\n\r\n\t\t\t\tSearch.checkPagePresence(tid, function () {\r\n\t\t\t\t\tSearch.topicDOM.update(0);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t});\r\n\t};\r\n\r\n\tSearch.checkPagePresence = function (tid, callback) {\r\n\t\tif (parseInt(ajaxify.data.tid, 10) !== parseInt(tid, 10)) {\r\n\t\t\tajaxify.go('topic/' + tid, callback);\r\n\t\t} else {\r\n\t\t\tcallback();\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.topicDOM = {\r\n\t\tactive: false,\r\n\t};\r\n\r\n\tSearch.topicDOM.prev = function () {\r\n\t\tSearch.topicDOM.update((Search.current.index === 0) ? Search.current.results.length - 1 : Search.current.index - 1);\r\n\t};\r\n\r\n\tSearch.topicDOM.next = function () {\r\n\t\tSearch.topicDOM.update((Search.current.index === Search.current.results.length - 1) ? 0 : Search.current.index + 1);\r\n\t};\r\n\r\n\tSearch.topicDOM.update = function (index) {\r\n\t\tvar topicSearchEl = $('.topic-search');\r\n\t\tSearch.current.index = index;\r\n\r\n\t\tSearch.topicDOM.start();\r\n\r\n\t\tif (Search.current.results.length > 0) {\r\n\t\t\ttopicSearchEl.find('.count').html((index + 1) + ' / ' + Search.current.results.length);\r\n\t\t\ttopicSearchEl.find('.prev, .next').removeAttr('disabled');\r\n\t\t\tvar data = {\r\n\t\t\t\tpid: Search.current.results[index],\r\n\t\t\t\ttid: Search.current.tid,\r\n\t\t\t\ttopicPostSort: config.topicPostSort,\r\n\t\t\t};\r\n\t\t\tsocket.emit('posts.getPidIndex', data, function (err, postIndex) {\r\n\t\t\t\tif (err) {\r\n\t\t\t\t\treturn app.alertError(err.message);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tnav.scrollToIndex(postIndex, true);\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\ttranslator.translate('[[search:no-matches]]', function (text) {\r\n\t\t\t\ttopicSearchEl.find('.count').html(text);\r\n\t\t\t});\r\n\t\t\ttopicSearchEl.removeClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.topicDOM.start = function () {\r\n\t\t$('.topic-search').removeClass('hidden');\r\n\t\tif (!Search.topicDOM.active) {\r\n\t\t\tSearch.topicDOM.active = true;\r\n\r\n\t\t\t// Bind to esc\r\n\t\t\trequire(['mousetrap'], function (mousetrap) {\r\n\t\t\t\tmousetrap.bind('esc', Search.topicDOM.end);\r\n\t\t\t});\r\n\t\t}\r\n\t};\r\n\r\n\tSearch.topicDOM.end = function () {\r\n\t\t$('.topic-search').addClass('hidden').find('.prev, .next').attr('disabled', 'disabled');\r\n\t\tSearch.topicDOM.active = false;\r\n\r\n\t\t// Unbind esc\r\n\t\trequire(['mousetrap'], function (mousetrap) {\r\n\t\t\tmousetrap.unbind('esc', Search.topicDOM.end);\r\n\t\t});\r\n\t};\r\n\r\n\treturn Search;\r\n});\r\n"]}